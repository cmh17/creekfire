---
title: "build_gam"
author: "Carrie Hashimoto"
date: "2024-07-26"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r, warning = FALSE, message = FALSE}
packages <- c('tidyverse','mgcv','gam','akima','readr','data.table','vroom',
              'foreach','doParallel','readr','caret')

# Identify missing (not installed) packages
new.packages <-  packages[!(packages %in% installed.packages()[,"Package"])]

# Install new (not installed) packages
if(length(new.packages)) install.packages(new.packages, repos='http://cran.rstudio.com/') else print('All required packages are installed.')

invisible(lapply(packages, library, character.only = TRUE))
```

```{r}
wd <- rprojroot::find_rstudio_root_file()
outDir <- file.path(wd, "Data", fsep="/")
suppressWarnings(dir.create(outDir)) 

num_cores <- detectCores() - 1
cl <- makeCluster(num_cores - 1)  # Use one less core than available
registerDoParallel(cl)
```

```{r}
df_final <- vroom::vroom("intermediate_results.csv")

# remove rows with NAs - all in aspect - why?
df_clean <- na.omit(df_final)

# ## 75% of the sample size
# smp_size <- floor(0.75 * nrow(df_clean))
# 
# ## set the seed to make your partition reproducible
# set.seed(123)
# train_ind <- sample(seq_len(nrow(df_final)), size = smp_size)
# 
# train <- df_final[train_ind, ]
# test <- df_final[-train_ind, ]

# explore relationships before building model
ggplot(df_clean, aes(x = temp, y = dNDVI)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "cs")) +
  labs(title = "dNDVI vs. Temperature (GAM)")

ggplot(df_clean, aes(x = temp, y = aET)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "cs")) +
  labs(title = "aET vs. Temperature (GAM)")

# fit linear models
lm_dNDVI <- lm(dNDVI ~ temp + precip + elev + aspect + slope + soil_moisture, data = df_clean)

#plot(lm_dNDVI)  # check residual plots

# fit GAM with splines on all data
gam_dNDVI <- mgcv::gam(dNDVI ~ s(temp) + s(precip) + s(elev) + s(aspect) + s(slope) + s(soil_moisture), data = df_clean)

dim(df_clean)
gam.check(gam_dNDVI, k.sample = 100000)

# compare models
summary(lm_dNDVI)
summary(gam_dNDVI)

# look at AIC
AIC(lm_dNDVI, gam_dNDVI)

plot.Gam(gam_dNDVI)
```

```{r}
# next step: see if the GAM is significantly better than the linear model


```

```{r}
stopCluster(cl)
registerDoSEQ()
```

