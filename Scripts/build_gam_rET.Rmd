---
title: "build_gam"
author: "Carrie Hashimoto"
date: "2024-07-26"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r, warning = FALSE, message = FALSE}
packages <- c('tidyverse','mgcv','gam','akima','readr','data.table','vroom',
              'foreach','doParallel','readr','caret')

# Identify missing (not installed) packages
new.packages <-  packages[!(packages %in% installed.packages()[,"Package"])]

# Install new (not installed) packages
if(length(new.packages)) install.packages(new.packages, repos='http://cran.rstudio.com/') else print('All required packages are installed.')

invisible(lapply(packages, library, character.only = TRUE))
```

```{r}
wd <- rprojroot::find_rstudio_root_file()
outDir <- file.path(wd, "Models", fsep="/")
suppressWarnings(dir.create(outDir)) 

num_cores <- detectCores() - 1
cl <- makeCluster(num_cores - 1)  # Use one less core than available
registerDoParallel(cl)
```

```{r}
df <- vroom::vroom("model_df.csv")
head(df)

# get a subset for visualization later
set.seed(0)

k <- 1000
n <- nrow(df)

folds <- sample(rep(1:k, length = n))

df_fold1 <- df[folds == 1,]
```

```{r}
predictors <- c("prefire_ndvi","dnbr","elev","slope","aspect",
                   "north","lat","temp","precip")
```

```{r}
# make the GAM
# first use all predictors, no interaction terms

# Fit the model using bam
bam_rET <- mgcv::bam(rET ~ s(prefire_ndvi) + s(dnbr) +
                       s(elev) + s(slope) + 
                       s(aspect) + s(north) +
                       s(lat) + s(temp) +
                       s(precip),
                     data = df, method = "fREML")

bam_rET.summary <- summary(bam_rET)
bam_rET.summary

# check model diagnostics
save(bam_rET, file = paste0(outDir, "/bam_rET.rds"))
```


```{r}
# try increasing the basis dimensions
# first use all predictors, no interaction terms

# fit the model using bam and variables of interest from lm
bam_rET_interaction <- mgcv::bam(rET ~ s(dnbr) + s(lat) + s(precip) + 
                                   te(prefire_ndvi,dnbr, bs="ps") + te(elev,dnbr, bs="ps") + 
                                   te(lat,dnbr, bs="ps") + te(lat,precip, bs="ps"),
                     data = df, method = "fREML")

bam_rET_interaction.summary <- summary(bam_rET_interaction)
bam_rET_interaction.summary

# check model diagnostics
gam.check(bam_rET_interaction) 

save(bam_rET_interaction, file=paste0(outDir,"/bam_rET_interaction_reduced.rds"))
```




```{r}
stopCluster(cl)
registerDoSEQ()
```

