---
title: "create_table"
author: "Carrie Hashimoto"
date: "2024-07-24"
output: html_document
editor_options: 
  chunk_output_type: inline
---

## Setup:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r, warning = FALSE, message = FALSE}
packages <- c('terra','ggplot2','DT', 'rprojroot',
              'tidyterra','dplyr',"data.table","doParallel","parallel")

# Identify missing (not installed) packages
new.packages = packages[!(packages %in% installed.packages()[,"Package"])]

# Install new (not installed) packages
if(length(new.packages)) install.packages(new.packages, repos='http://cran.rstudio.com/') else print('All required packages are installed.')

invisible(lapply(packages, library, character.only = TRUE))
```

```{r}
wd <- rprojroot::find_rstudio_root_file()
outDir <- file.path(wd, "Data", fsep="/")
suppressWarnings(dir.create(outDir)) 
```

```{r}
# Initialize the number of cores to use
num_cores <- detectCores() - 1  # Use one less than the number of available cores
cl <- makeCluster(num_cores)
registerDoParallel(cl)
```


## Import all the rasters:

temp -  NLDAS hourly mean over 2020-03-04 to 2020-09-04 
- Could use ECOSTRESS - revisit if time
precip - TerraClimate monthly total 2020-03-01 to 2020-09-01
soil moisture - TerraClimate monthly total 2020-03-01 to 2020-09-01

Prefire NDVI - HLS mean 2020-06-01 to 2020-08-30
Prefire NBR - HLS mean 2020-06-01 to 2020-08-30
Prefire ET - OpenET monthly total 2020-06, 2021-07, 2021-08

Postfire NDVI - HLS mean 2021-06-01 to 2021-08-30
Postfire NBR - HLS mean 2021-06-01 to 2021-08-30
Postfire ET - OpenET monthly total 2021-06, 2021-07, 2021-08

```{r}
# boundary vec
boundary_vec <- terra::vect(paste0(wd,"/Data/creekfire_1km_buffer.geojson"))

# HUC12 in 10 km buffer
HUC12 <- terra::vect((paste0(wd,"/Data/CreekFireHUC12_in_buffer.geojson")))

# Import the actual fire boundary
creekfire_geojson <- terra::vect(paste0(wd,"/Data/creekfire.geojson"))

# ET data
prefire_et <- terra::rast(paste0(wd,"/Data/openET_data/tiffs/prefire_mean_ET.tif"))
names(prefire_et) <- "prefire_et"

postfire_et <- terra::rast(paste0(wd,"/Data/openET_data/tiffs/postfire_mean_ET.tif"))
names(postfire_et) <- "postfire_et"

elevation <- terra::rast(paste0(wd,"/Data/SRTM_data/SRTM_mosaic.tif"))
names(elevation) <- "elevation"

temperature <- terra::rast(paste0(wd,"/Data/NLDAS2_DAILY_tasmean_2020-03-04_2020-09-04_36p8990to37p7370N_-119p5980to-118p8290E.tasmean.tif"))
names(temperature) <- "temperature"

precipitation <- terra::rast(paste0(wd,"/Data/TERRACLIMATE_pr_2020-03-01_2020-08-31_36p8990to37p7370N_-119p5980to-118p8290E.pr.tif"))
names(precipitation) <- "precipitation"

soil_moisture <- terra::rast(paste0(wd,"/Data/TERRACLIMATE_soil_2020-03-01_2020-08-31_36p8990to37p7370N_-119p5980to-118p8290E.soil.tif"))
names(soil_moisture) <- "soil_moisture"

slope <- terra::rast(paste0(wd,"/Data/SRTM_data/srtm_slope.tif"))
names(slope) <- "slope"

aspect <- terra::rast(paste0(wd,"/Data/SRTM_data/srtm_aspect.tif"))
names(aspect) <- "aspect"

prefire_ndvi <- terra::rast(paste0(wd,"/Data/HLS_data/prefire_mean_ndvi.tif"))
names(prefire_ndvi) <- "prefire_ndvi"

prefire_nbr <- terra::rast(paste0(wd,"/Data/HLS_data/prefire_mean_nbr.tif"))
names(prefire_nbr) <- "prefire_nbr"

dndvi <- terra::rast(paste0(wd,"/Data/HLS_data/diff_mean_ndvi.tif"))
names(dndvi) <- "dndvi"

dnbr <- terra::rast(paste0(wd,"/Data/HLS_data/diff_mean_nbr.tif"))
names(dnbr) <- "dnbr"

rdnbr <- dnbr / sqrt(abs(prefire_nbr/1000))
names(rdnbr) <- "rdnbr"

# lordy be
# need to calculate northness

# I assume these are in degrees
north <- sin(slope * pi / 180) * cos(aspect * pi / 180)
names(north) <- "north" 

rasterized_boundary <- terra::rasterize(creekfire_geojson, prefire_et, field=TRUE, background=NA)
names(rasterized_boundary) <- "burned"

rasterized_buffer <- terra::rasterize(boundary_vec, prefire_et, field=TRUE, background=NA)
names(rasterized_buffer) <- "in_buffer"

rasterized_HUC12 <- terra::rasterize(HUC12, prefire_et, field="HUC12", background=NA)
names(rasterized_HUC12) <- "HUC12"


postfire_et_resampled <- terra::resample(postfire_et,prefire_et)
elevation_resampled <- terra::resample(elevation,prefire_et)
temperature_resampled <- terra::resample(temperature,prefire_et)
precipitation_resampled <- terra::resample(precipitation,prefire_et)
soil_moisture_resampled <- terra::resample(soil_moisture,prefire_et)
slope_resampled <- terra::resample(slope,prefire_et)
aspect_resampled <- terra::resample(aspect,prefire_et)
prefire_ndvi_resampled <-  terra::resample(prefire_ndvi,prefire_et)
prefire_nbr_resampled <-  terra::resample(prefire_nbr,prefire_et)
dndvi_resampled <- terra::resample(dndvi,prefire_et)
dnbr_resampled <- terra::resample(dnbr,prefire_et)
rdnbr_resampled <- terra::resample(rdnbr,prefire_et)
north_resampled <- terra::resample(north,prefire_et)

```



Trim everything to the buffer extent.
```{r}
# prefire_et_cropped <- terra::crop(prefire_et,boundary_vec,mask=TRUE)
# postfire_et_resampled_cropped <- terra::crop(postfire_et_resampled,boundary_vec,mask=TRUE)
# 
# elevation_resampled_cropped <- terra::crop(elevation_resampled,boundary_vec,mask=TRUE)
# temperature_resampled_cropped <- terra::crop(temperature_resampled,boundary_vec,mask=TRUE)
# precipitation_resampled_cropped <- terra::crop(precipitation_resampled,boundary_vec,mask=TRUE)
# soil_moisture_resampled_cropped <- terra::crop(soil_moisture_resampled,boundary_vec,mask=TRUE)
# prefire_ndvi_resampled_cropped <- terra::crop(prefire_ndvi_resampled,boundary_vec,mask=TRUE)
# prefire_nbr_resampled_cropped <- terra::crop(prefire_nbr_resampled,boundary_vec,mask=TRUE)
# dndvi_resampled_cropped <- terra::crop(dndvi_resampled,boundary_vec,mask=TRUE)
# dnbr_resampled_cropped <- terra::crop(dnbr_resampled,boundary_vec,mask=TRUE)
# rdnbr_resampled_cropped <- terra::crop(rdnbr_resampled,boundary_vec,mask=TRUE)
# slope_resampled_cropped <- terra::crop(slope_resampled,boundary_vec,mask=TRUE)
# aspect_resampled_cropped <- terra::crop(aspect_resampled,boundary_vec,mask=TRUE)
# north_resampled_cropped <- terra::crop(north_resampled,boundary_vec,mask=TRUE)
# rasterized_boundary_cropped <- terra::crop(rasterized_boundary,boundary_vec,mask=TRUE)
# rasterized_buffer_cropped <- terra::crop(rasterized_buffer,boundary_vec,mask=TRUE)
# rasterized_HUC12_cropped <- terra::crop(rasterized_HUC12,boundary_vec,mask=TRUE)

```


Create a data table with all these data in it.
```{r}
# Extract values from other rasters
coords <- terra::crds(prefire_et_cropped)
colnames(coords) <- c("x","y")
prefire_et_values <- terra::extract(prefire_et_cropped, coords)
postfire_et_values <- terra::extract(postfire_et_resampled_cropped, coords)
temperature_values <- terra::extract(temperature_resampled_cropped, coords)
precipitation_values <- terra::extract(precipitation_resampled_cropped, coords)
elevation_values <- terra::extract(elevation_resampled_cropped, coords)
soil_moisture_values <- terra::extract(soil_moisture_resampled_cropped, coords)
prefire_ndvi_values <- terra::extract(prefire_ndvi_resampled_cropped, coords)
prefire_nbr_values <- terra::extract(prefire_nbr_resampled_cropped, coords)
dndvi_values <- terra::extract(dndvi_resampled_cropped, coords)
dnbr_values <- terra::extract(dnbr_resampled_cropped, coords)
rdnbr_values <- terra::extract(rdnbr_resampled_cropped, coords)
aspect_values <- terra::extract(aspect_resampled_cropped, coords)
slope_values <- terra::extract(slope_resampled, coords)
north_values <- terra::extract(north_resampled, coords)
rasterized_boundary_values <- terra::extract(rasterized_boundary_cropped, coords)
rasterized_buffer_values <- terra::extract(rasterized_buffer_cropped, coords)
rasterized_HUC12_values <- terra::extract(rasterized_HUC12_cropped, coords)


# Create the data.table
data_table <- data.table(
  lat = coords[, "y"],
  lon = coords[, "x"],
  within_burn_area = rasterized_boundary_values[,"burned"],
  within_buffer = rasterized_buffer_values[,"in_buffer"],
  huc12 = rasterized_HUC12_values[,"HUC12"],
  prefire_ndvi = prefire_ndvi_values[,"prefire_ndvi"],
  prefire_nbr = prefire_nbr_values[,"prefire_nbr"],
  dndvi = dndvi_values[, "dndvi"],
  dnbr = dnbr_values[, "dnbr"], 
  rdnbr = rdnbr_values[, "rdnbr"],
  prefire_et = prefire_et_values[, "prefire_et"],              
  postfire_et = postfire_et_values[, "postfire_et"],
  temp = temperature_values[, "temperature"],    
  precip = precipitation_values[, "precipitation"], 
  elev = elevation_values[, "elevation"],    
  aspect = aspect_values[,"aspect"], 
  slope = slope_values[,"slope"], 
  north = north_values[, "north"],
  soil_moisture = soil_moisture_values[, "soil_moisture"] 
)

# remove rows outside the buffer
data_table_cleaned <- data_table[!is.na(data_table$within_buffer)]

# everything remaining is inside the buffer
# so if it still has within_boundary is.na, then it must be in the buffer
# but outside the burn area
data_table_cleaned[is.na(data_table_cleaned$within_burn_area)]$within_burn_area <- FALSE

# save results
write.csv(data_table_cleaned, paste0(wd,"/Data/big_table.csv"), row.names = FALSE)

# check point spatial distribution
set.seed(0)  # For reproducibility
sample_size <- 1000  # Number of random points to sample

subset_df <- data_table_cleaned %>%
  sample_n(sample_size)
plot(creekfire_geojson)
# Plot the selected points using ggplot2
ggplot(subset_df, aes(x = lon, y = lat)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
  labs(title = "Random Subset of Longitude and Latitude Points",
       x = "Longitude", y = "Latitude")
```


```{r}
stopCluster(cl)
registerDoSEQ()
```








